# 微服务

## 定义

微服务架构是一种架构模式或者一种架构风格，它提倡将单一应用程序划分成一组小的服务，每个服务运行独立的自己的进程，
服务之间互相协调、互相配合，为用户提供最终价值。服务之间采用轻量级的通信机制互相沟通。

## 微服务架构

[](./pictures/微服务技术架构.jpeg)

### 服务发现

每一个服务都通过服务端内置的功能注册到注册中心，服务消费者不断轮询注册中心发现对应的服务，使用内置负载均衡调用服务。
这是目前的主流做法，缺点是：对多语言环境不是很好，你需要单独给消费者的客户端开发服务发现和负载均衡功能。

### 网关

网关的作用如下：

+ **反向路由**：很多时候，公司不想让外部人员看到我们公司的内部，就需要网关来进行反向路由。即将外部请求转换成内部具体服务调用。

+ **安全认证**：网络中会有很多恶意访问，譬如爬虫，譬如黑客攻击，网关维护安全功能。

+ **限流熔断**：当请求很多服务不堪重负，会让我们的服务自动关闭，导致不能用服务。限流熔断可以有效的避免这类问题。

+ **日志监控**：所有的外面的请求都会经过网关，这样我们就可以使用网关来记录日志信息。

+ **灰度发布，蓝绿部署**：是指能够平滑过渡的一种发布方式。在其上可以进行 A/B testing。

开源网关Zuul：

[](./pictures/开源网关Zuul架构.jpeg)

Zuul 网关核心其实是一个 Servlet，所有请求都会经过 Zuul Servlet 传到 ZuulFilter Runner，然后分发到三种过滤器。

先说说架构图左半部分，分别是使用 Groovy 实现的前置路由过滤器，路由过滤器，后置路由过滤器。

一般请求都会先经过前置路由过滤器处理，一般的自定义 Java 封装逻辑也会在这里实现。

路由过滤器，实现的是找到对应的微服务进行调用。调用完了，响应回来，会经过后置路由过滤器，通过后置路由过滤器我们可以封装日志审计的处理。

可以说 Zuul 网关最大的特色就是它的三层过滤器。架构图右半部分，是 Zuul 网关设计的自定义过滤器加载机制。

网关内部会有生产者消费者模型，自动的将过滤器脚本发布到 Zuul 网关读取加载运行。

### 配置中心

以前，开发人员把配置文件放在开发文件里面，这样会有很多隐患。譬如，配置规范不同，无法追溯配置人员。
一旦需要大规模改动配置，改动时间会很长，无法追溯配置人员，从而影响整个产品，后果是我们承担不起的。
因此就有配置中心这个喽！现在的开源中心有百度配置中心 Disconf，Spring Cloud Config，Apollo。
今天重点说说现在应用质量不错的配置中心，携程开源的阿波罗（Apollo）：

### 通讯方式

| 特性 | RPC | REST |
| --- | --- | --- | 
| 耦合性 | 强耦合 | 松散耦合 |
| 消息协议 | TCP | HTTP |
| 通讯协议 | 二进制 | 文本XML, JSON |
| 性能 | 高 | 低于RPC |
| IDL | protobuf | swagger |



